{% extends "base.html" %}
{% block title %}Productos y Calculadora - Control de Ventas{% endblock %}

{% block content %}

{% if error %}
<div class="alert alert-danger py-2 mb-3">{{ error }}</div>
{% endif %}
{% if success %}
<div class="alert alert-success py-2 mb-3">{{ success }}</div>
{% endif %}

<!-- CALCULADORA -->
<div class="card p-3 mb-4">
    <h5 class="mb-2 text-accent text-center">Calculadora de precios</h5>
    <p class="text-secondary-custom small mb-3 text-center">
        Ingresa el <b>costo</b>, el <b>margen deseado</b> (puede ser 0%) y la cantidad.
        La calculadora sugiere un precio, utilidad por unidad y utilidad total.  
        Puedes guardar el resultado en el catálogo para usarlo luego en Ventas.
    </p>

    <form method="post" action="{{ url_for('productos') }}">
        <input type="hidden" name="form_type" value="calculator">
        <div class="row g-2 align-items-end">
            <div class="col-12 col-md-3">
                <label class="form-label text-secondary-custom mb-1">Nombre de producto</label>
                <input
                    type="text"
                    name="product_name"
                    class="form-control form-control-sm text-center"
                    placeholder="Ej: Flor Nacional"
                    value="{{ product_name_input or '' }}"
                >
            </div>
            <div class="col-6 col-md-2">
                <label class="form-label text-secondary-custom mb-1">Costo (₡)</label>
                <input
                    type="number"
                    step="0.01"
                    name="cost"
                    class="form-control form-control-sm text-end"
                    value="{{ cost_input or '0' }}"
                >
            </div>
            <div class="col-6 col-md-2">
                <label class="form-label text-secondary-custom mb-1">Margen (%)</label>
                <input
                    type="number"
                    step="0.01"
                    name="margin"
                    class="form-control form-control-sm text-end"
                    value="{{ margin_input or '0' }}"
                >
            </div>
            <div class="col-6 col-md-2">
                <label class="form-label text-secondary-custom mb-1">Cantidad</label>
                <input
                    type="number"
                    name="quantity"
                    class="form-control form-control-sm text-end"
                    min="1"
                    value="{{ quantity_input or '1' }}"
                >
            </div>
            <div class="col-6 col-md-3">
                <label class="form-label text-secondary-custom mb-1">Opciones</label>
                <div class="form-check mb-2">
                    <input
                        class="form-check-input"
                        type="checkbox"
                        value="1"
                        id="save_to_catalog"
                        name="save_to_catalog"
                    >
                    <label class="form-check-label text-secondary-custom" for="save_to_catalog">
                        Guardar / actualizar en catálogo
                    </label>
                </div>
                <button type="submit" class="btn btn-primary btn-sm w-100">
                    <i class="bi bi-calculator me-1"></i> Calcular
                </button>
            </div>
        </div>
    </form>

    {% if price_result is not none %}
    <hr class="my-3">
    <div class="row text-center g-2">
        <div class="col-6 col-md-3">
            <div class="border rounded-3 p-2">
                <div class="text-secondary-custom small">Precio sugerido</div>
                <div class="text-accent fw-semibold">₡{{ "%.2f"|format(price_result) }}</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="border rounded-3 p-2">
                <div class="text-secondary-custom small">Utilidad unidad</div>
                <div class="text-accent fw-semibold">₡{{ "%.2f"|format(profit_unit or 0) }}</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="border rounded-3 p-2">
                <div class="text-secondary-custom small">Utilidad total</div>
                <div class="text-accent fw-semibold">₡{{ "%.2f"|format(profit_total or 0) }}</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="border rounded-3 p-2">
                <div class="text-secondary-custom small">Margen efectivo</div>
                <div class="text-accent fw-semibold">{{ "%.2f"|format(margin_used or 0) }} %</div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- CATÁLOGO -->
<div class="card p-3">
    <h5 class="mb-2 text-accent text-center">Catálogo de productos</h5>
    <p class="text-secondary-custom small mb-3 text-center">
        Administra los productos que usarás como plantilla en tus ventas.  
        Eliminar un producto no borra las ventas históricas.
    </p>

    <!-- Formulario directo -->
    <form method="post" action="{{ url_for('productos') }}" class="mb-3">
        <input type="hidden" name="form_type" value="catalog">
        <div class="row g-2 align-items-end">
            <div class="col-12 col-md-4">
                <label class="form-label text-secondary-custom mb-1">Nombre de producto</label>
                <input
                    type="text"
                    name="name"
                    class="form-control form-control-sm text-center"
                    required
                >
            </div>
            <div class="col-6 col-md-3">
                <label class="form-label text-secondary-custom mb-1">Costo (₡)</label>
                <input
                    type="number"
                    step="0.01"
                    name="cost"
                    class="form-control form-control-sm text-end"
                    value="0"
                >
            </div>
            <div class="col-6 col-md-3">
                <label class="form-label text-secondary-custom mb-1">Precio (₡)</label>
                <input
                    type="number"
                    step="0.01"
                    name="price"
                    class="form-control form-control-sm text-end"
                    value="0"
                >
            </div>
            <div class="col-12 col-md-2 d-grid">
                <button type="submit" class="btn btn-primary btn-sm">
                    <i class="bi bi-save me-1"></i> Guardar
                </button>
            </div>
        </div>
    </form>

    {% if products and products|length > 0 %}
    <!-- Tabla escritorio -->
    <div class="table-responsive d-none d-md-block">
        <table class="table table-dark table-striped table-sm align-middle mb-0">
            <thead>
                <tr class="text-center">
                    <th>Nombre</th>
                    <th>Costo (₡)</th>
                    <th>Precio (₡)</th>
                    <th>Ganancia (₡)</th>
                    <th>Margen (%)</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for p in products %}
                <tr>
                    <td class="text-center">{{ p.name }}</td>
                    <td class="text-center text-accent">{{ p.cost|format_num }}</td>
                    <td class="text-center text-accent">{{ p.price|format_num }}</td>
                    <td class="text-center text-accent">
                        {{ (p.price - p.cost)|format_num }}
                    </td>
                    <td class="text-center text-accent">{{ "%.2f"|format(p.margin_percent) }}</td>
                    <td class="text-center">
                        <form
                            method="post"
                            action="{{ url_for('delete_product', product_id=p.id) }}"
                            class="d-inline"
                        >
                            <button
                                type="submit"
                                class="btn btn-sm btn-outline-danger"
                                onclick="return doubleConfirm('¿Eliminar este producto?', 'No se borran las ventas, solo el catálogo. ¿Confirmas?');"
                            >
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Versión móvil -->
    <div class="d-block d-md-none mt-2">
        {% for p in products %}
        <div class="border rounded-3 p-2 mb-2 text-center">
            <div class="fw-semibold text-accent">{{ p.name }}</div>
            <div class="text-secondary-custom small">
                Costo: <span class="text-accent">₡{{ p.cost|format_num }}</span> |
                Precio: <span class="text-accent">₡{{ p.price|format_num }}</span>
            </div>
            <div class="text-secondary-custom small">
                Ganancia: <span class="text-accent">₡{{ (p.price - p.cost)|format_num }}</span>
            </div>
            <div class="text-secondary-custom small">
                Margen: <span class="text-accent">{{ "%.2f"|format(p.margin_percent) }} %</span>
            </div>
            <div class="mt-1">
                <form
                    method="post"
                    action="{{ url_for('delete_product', product_id=p.id) }}"
                    class="d-inline"
                >
                    <button
                        type="submit"
                        class="btn btn-sm btn-outline-danger"
                        onclick="return doubleConfirm('¿Eliminar este producto?', 'No se borran las ventas, solo el catálogo. ¿Confirmas?');"
                    >
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-secondary-custom small mb-0 text-center">
        No hay productos registrados todavía.
    </p>
    {% endif %}
</div>

{% endblock %}
