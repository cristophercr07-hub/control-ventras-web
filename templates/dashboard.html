{% extends "base.html" %}
{% block title %}Dashboard - Control de Ventas{% endblock %}

{% block content %}

<div class="row">
    <div class="col-12">
        <div class="card p-4 mb-4">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
                <div>
                    <h2 class="mb-1 text-accent">Dashboard de rendimiento</h2>
                    <p class="text-secondary-custom mb-0">
                        Resumen visual de tus ventas, ganancias, tickets promedio y comportamiento por producto, semana y usuario.
                    </p>
                </div>
                <form method="get" action="{{ url_for('dashboard') }}" class="mt-3 mt-md-0">
                    <div class="row g-2 align-items-end">
                        <div class="col-auto">
                            <label class="form-label text-secondary-custom mb-1">Desde</label>
                            <input
                                type="date"
                                name="date_from"
                                class="form-control text-center"
                                value="{{ date_from or '' }}"
                            >
                        </div>
                        <div class="col-auto">
                            <label class="form-label text-secondary-custom mb-1">Hasta</label>
                            <input
                                type="date"
                                name="date_to"
                                class="form-control text-center"
                                value="{{ date_to or '' }}"
                            >
                        </div>
                        <div class="col-auto">
                            <label class="form-label text-secondary-custom mb-1 d-block">Rango rápido</label>
                            <div class="btn-group">
                                <button type="submit" name="preset" value="week"
                                        class="btn btn-sm btn-outline-light {% if preset == 'week' %}active{% endif %}">
                                    7 días
                                </button>
                                <button type="submit" name="preset" value="4weeks"
                                        class="btn btn-sm btn-outline-light {% if preset == '4weeks' %}active{% endif %}">
                                    4 semanas
                                </button>
                                <button type="submit" name="preset" value="month"
                                        class="btn btn-sm btn-outline-light {% if preset == 'month' %}active{% endif %}">
                                    Mes
                                </button>
                                <button type="submit" name="preset" value="year"
                                        class="btn btn-sm btn-outline-light {% if preset == 'year' %}active{% endif %}">
                                    Año
                                </button>
                            </div>
                        </div>
                        <div class="col-auto">
                            <label class="form-label text-secondary-custom mb-1 d-block">&nbsp;</label>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-funnel me-1"></i> Aplicar
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- ALERTAS (E) -->
            {% if alert_no_data %}
                <div class="alert alert-warning text-center mb-2">
                    No hay datos de ventas en el rango seleccionado. Ajusta las fechas o realiza nuevas ventas.
                </div>
            {% endif %}

            {% if alert_pending %}
                <div class="alert alert-danger text-center mb-2">
                    Tienes <strong>{{ pending_count }}</strong> ventas pendientes por un total de
                    <strong>₡{{ "%.2f"|format(pending_revenue) }}</strong>. Revisa cobros y estatus.
                </div>
            {% endif %}

            {% if alert_low_margin and not alert_no_data %}
                <div class="alert alert-warning text-center mb-0">
                    Tu margen de ganancia en este período es de
                    <strong>{{ "%.2f"|format(margin_percent) }}%</strong>, por debajo del objetivo sugerido de
                    <strong>15%</strong>. Considera revisar precios y costos.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- KPIs SUPERIORES -->
<div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
        <div class="card p-3 h-100 text-center">
            <p class="text-secondary-custom mb-1">Ventas (registros)</p>
            <h3 class="mb-1 text-accent">{{ total_ventas }}</h3>
            <small class="text-secondary-custom">Total de operaciones en el rango seleccionado.</small>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="card p-3 h-100 text-center">
            <p class="text-secondary-custom mb-1">Ingresos totales (₡)</p>
            <h3 class="mb-1 text-accent">{{ "%.2f"|format(total_revenue) }}</h3>
            <small class="text-secondary-custom">Suma de todos los montos vendidos.</small>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="card p-3 h-100 text-center">
            <p class="text-secondary-custom mb-1">Ganancia total (₡)</p>
            <h3 class="mb-1 text-accent">{{ "%.2f"|format(total_ganancia) }}</h3>
            <small class="text-secondary-custom">Ingresos menos costos.</small>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="card p-3 h-100 text-center">
            <p class="text-secondary-custom mb-1">Ticket promedio (₡)</p>
            <h3 class="mb-1 text-accent">{{ "%.2f"|format(avg_ticket) }}</h3>
            <small class="text-secondary-custom">Promedio por venta.</small>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
        <div class="card p-3 h-100 text-center">
            <p class="text-secondary-custom mb-1">Margen (%)</p>
            <h3 class="mb-1 text-accent">{{ "%.2f"|format(margin_percent) }}%</h3>
            <small class="text-secondary-custom">Ganancia / ingresos del período.</small>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="card p-3 h-100 text-center">
            <p class="text-secondary-custom mb-1">Pagado (₡)</p>
            <h3 class="mb-1 text-accent">{{ "%.2f"|format(paid_revenue) }}</h3>
            <small class="text-secondary-custom">Monto efectivamente cobrado.</small>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="card p-3 h-100 text-center">
            <p class="text-secondary-custom mb-1">Pendiente (₡)</p>
            <h3 class="mb-1 text-accent">{{ "%.2f"|format(pending_revenue) }}</h3>
            <small class="text-secondary-custom">Ventas aún por cobrar.</small>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="card p-3 h-100 text-center">
            <p class="text-secondary-custom mb-1">Costo total (₡)</p>
            <h3 class="mb-1 text-accent">{{ "%.2f"|format(total_cost) }}</h3>
            <small class="text-secondary-custom">Base de costos del período.</small>
        </div>
    </div>
</div>

<!-- FILA DE GRÁFICOS 1: TOP PRODUCTOS + PAGADO VS PENDIENTE -->
<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card p-3 h-100">
            <h4 class="mb-2 text-accent text-center">Top productos por ganancia</h4>
            <p class="text-secondary-custom text-center mb-3">
                Muestra los productos que más aporte de ganancia tienen en el rango seleccionado.
            </p>
            <div class="chart-container" style="position: relative; height: 260px;">
                <canvas id="topProductsChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card p-3 h-100">
            <h4 class="mb-2 text-accent text-center">Distribución Pagado vs Pendiente</h4>
            <p class="text-secondary-custom text-center mb-3">
                Relación entre montos cobrados y montos aún pendientes.
            </p>
            <div class="chart-container" style="position: relative; height: 260px;">
                <canvas id="paidPendingChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- FILA DE GRÁFICOS 2: GANANCIA SEMANAL + GANANCIA POR USUARIO -->
<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card p-3 h-100">
            <h4 class="mb-2 text-accent text-center">Ganancia semanal</h4>
            <p class="text-secondary-custom text-center mb-3">
                Evolución de la ganancia agregada por semana (formato Año-Semana ISO).
            </p>
            <div class="chart-container" style="position: relative; height: 260px;">
                <canvas id="weeklyProfitChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card p-3 h-100">
            <h4 class="mb-2 text-accent text-center">Ganancia por usuario</h4>
            <p class="text-secondary-custom text-center mb-3">
                Comparativa de ganancia atribuida a cada usuario del sistema.
            </p>
            <div class="chart-container" style="position: relative; height: 260px;">
                <canvas id="userProfitChart"></canvas>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Datos desde Flask
    const topLabels = {{ top_labels|tojson }};
    const topValues = {{ top_values|tojson }};

    const paidPendingLabels = {{ paid_pending_labels|tojson }};
    const paidPendingValues = {{ paid_pending_values|tojson }};

    const weekLabels = {{ week_labels|tojson }};
    const weekValues = {{ week_values|tojson }};

    const userLabels = {{ user_labels|tojson }};
    const userValues = {{ user_values|tojson }};

    // Helper para crear un gráfico de dona
    function createDoughnutChart(ctx, labels, data) {
        return new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: "bottom",
                        labels: {
                            color: "#e0e0e0",
                        }
                    }
                }
            }
        });
    }

    // Helper para crear gráfico de líneas
    function createLineChart(ctx, labels, data) {
        return new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [{
                    label: "Ganancia (₡)",
                    data: data,
                    tension: 0.3,
                    fill: false,
                    borderWidth: 2,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        ticks: { color: "#cccccc" },
                        grid: { display: false }
                    },
                    y: {
                        ticks: { color: "#cccccc" },
                        grid: { color: "rgba(255,255,255,0.08)" }
                    }
                }
            }
        });
    }

    // Helper para crear gráfico de barras
    function createBarChart(ctx, labels, data) {
        return new Chart(ctx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: [{
                    label: "Ganancia (₡)",
                    data: data,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        ticks: { color: "#cccccc" },
                        grid: { display: false }
                    },
                    y: {
                        ticks: { color: "#cccccc" },
                        grid: { color: "rgba(255,255,255,0.08)" }
                    }
                }
            }
        });
    }

    // Gráfico Top Productos (dona)
    const topCanvas = document.getElementById("topProductsChart");
    if (topCanvas && topLabels.length > 0) {
        createDoughnutChart(topCanvas.getContext("2d"), topLabels, topValues);
    }

    // Gráfico Pagado vs Pendiente (dona)
    const paidPendingCanvas = document.getElementById("paidPendingChart");
    if (paidPendingCanvas && paidPendingLabels.length > 0) {
        createDoughnutChart(paidPendingCanvas.getContext("2d"), paidPendingLabels, paidPendingValues);
    }

    // Gráfico Ganancia semanal (línea)
    const weeklyCanvas = document.getElementById("weeklyProfitChart");
    if (weeklyCanvas && weekLabels.length > 0) {
        createLineChart(weeklyCanvas.getContext("2d"), weekLabels, weekValues);
    }

    // Gráfico Ganancia por usuario (barras)
    const userCanvas = document.getElementById("userProfitChart");
    if (userCanvas && userLabels.length > 0) {
        createBarChart(userCanvas.getContext("2d"), userLabels, userValues);
    }
});
</script>
{% endblock %}
