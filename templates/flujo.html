{% extends "base.html" %}
{% block title %}Control de Flujo - Control de Ventas{% endblock %}

{% block content %}

{% if error %}
    <div class="alert alert-danger py-2 mb-3">{{ error }}</div>
{% endif %}
{% if success %}
    <div class="alert alert-success py-2 mb-3">{{ success }}</div>
{% endif %}

<!-- FORMULARIO DE MOVIMIENTOS -->
<div class="row">
    <div class="col-12">
        <div class="card p-4 mb-4">
            <h2 class="mb-3 text-accent">Registrar movimiento</h2>
            <p class="text-secondary-custom text-center mb-3">
                Registra tus <b>gastos</b> y <b>reinversiones</b> asociados al negocio. Esto permite
                calcular el flujo neto, tu ahorro real y compararlo contra el objetivo de ahorro del 10%
                de tus ganancias.
            </p>

            <form method="post" action="{{ url_for('flujo') }}">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3 col-12">
                        <label class="form-label text-secondary-custom">Fecha</label>
                        <input
                            type="date"
                            name="date"
                            class="form-control text-center"
                            data-autotoday="1"
                        >
                    </div>
                    <div class="col-md-3 col-12">
                        <label class="form-label text-secondary-custom">Descripción</label>
                        <input
                            type="text"
                            name="description"
                            class="form-control text-center"
                            placeholder="Ej: Compra de empaques"
                            required
                        >
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label text-secondary-custom">Tipo</label>
                        <select name="category" class="form-select text-center">
                            <option value="Gasto">Gasto</option>
                            <option value="Reinversión">Reinversión</option>
                        </select>
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label text-secondary-custom">Monto (₡)</label>
                        <input
                            type="number"
                            step="0.01"
                            name="amount"
                            class="form-control text-end"
                            value="0"
                            required
                        >
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <button type="submit" class="btn btn-primary w-100 w-md-auto">
                        <i class="bi bi-save me-1"></i> Guardar movimiento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- FILTROS + RESUMEN -->
<div class="row">
    <div class="col-12">
        <div class="card p-4 mb-4">
            <h2 class="mb-3 text-accent">Resumen y filtros</h2>

            <form method="get" action="{{ url_for('flujo') }}" class="mb-3">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3 col-6">
                        <label class="form-label text-secondary-custom">Desde</label>
                        <input
                            type="date"
                            name="date_from"
                            class="form-control text-center"
                            value="{{ date_from or '' }}"
                        >
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label text-secondary-custom">Hasta</label>
                        <input
                            type="date"
                            name="date_to"
                            class="form-control text-center"
                            value="{{ date_to or '' }}"
                        >
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label text-secondary-custom">Tipo</label>
                        <select name="category_filter" class="form-select text-center">
                            <option value="" {% if not category_filter %}selected{% endif %}>Todos</option>
                            <option value="Gasto" {% if category_filter == 'Gasto' %}selected{% endif %}>Gasto</option>
                            <option value="Reinversión" {% if category_filter == 'Reinversión' %}selected{% endif %}>Reinversión</option>
                        </select>
                    </div>
                    <div class="col-md-3 col-6">
                        <button type="submit" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-funnel me-1"></i> Aplicar filtros
                        </button>
                        <a href="{{ url_for('flujo') }}" class="btn btn-outline-light w-100">
                            <i class="bi bi-arrow-counterclockwise me-1"></i> Limpiar filtros
                        </a>
                    </div>
                </div>
            </form>

            <div class="row text-center">
                <div class="col-md-2 col-6 mb-2">
                    <p class="text-secondary-custom">
                        Ingresos (₡)<br>
                        <span class="text-accent">{{ "%.2f"|format(total_ingresos) }}</span>
                    </p>
                </div>
                <div class="col-md-2 col-6 mb-2">
                    <p class="text-secondary-custom">
                        Ganancia (₡)<br>
                        <span class="text-accent">{{ "%.2f"|format(total_ganancia) }}</span>
                    </p>
                </div>
                <div class="col-md-2 col-6 mb-2">
                    <p class="text-secondary-custom">
                        Gastos (₡)<br>
                        <span class="text-accent">{{ "%.2f"|format(total_gastos) }}</span>
                    </p>
                </div>
                <div class="col-md-2 col-6 mb-2">
                    <p class="text-secondary-custom">
                        Reinversión (₡)<br>
                        <span class="text-accent">{{ "%.2f"|format(total_reinv) }}</span>
                    </p>
                </div>
                <div class="col-md-2 col-6 mb-2">
                    <p class="text-secondary-custom">
                        Egresos totales (₡)<br>
                        <span class="text-accent">{{ "%.2f"|format(total_egresos) }}</span>
                    </p>
                </div>
                <div class="col-md-2 col-6 mb-2">
                    <p class="text-secondary-custom">
                        Neto (ganancia - egresos) (₡)<br>
                        <span class="text-accent">{{ "%.2f"|format(neto) }}</span>
                    </p>
                </div>
            </div>

            <hr>

            <div class="row text-center">
                <div class="col-md-4 col-12 mb-2">
                    <p class="text-secondary-custom">
                        Ahorro objetivo (10% de la ganancia)<br>
                        <span class="text-accent">{{ "%.2f"|format(ahorro_objetivo) }} ₡</span>
                    </p>
                </div>
                <div class="col-md-4 col-12 mb-2">
                    <p class="text-secondary-custom">
                        Ahorro real estimado (máx[neto, 0])<br>
                        <span class="text-accent">{{ "%.2f"|format(ahorro_real) }} ₡</span>
                    </p>
                </div>
                <div class="col-md-4 col-12 mb-2">
                    <p class="text-secondary-custom">
                        Ahorro faltante para meta<br>
                        <span class="text-accent">{{ "%.2f"|format(ahorro_faltante) }} ₡</span>
                    </p>
                </div>
            </div>

            <p class="text-secondary-custom text-center mt-2 mb-0">
                {% if meta_cumplida %}
                    ¡Meta de ahorro mensual del 10% <span class="text-accent">cumplida</span> en el periodo filtrado!
                {% else %}
                    Aún no alcanzas el 10% de ahorro sobre la ganancia en el periodo filtrado.
                    Usa este indicador para ajustar tus gastos y tu reinversión.
                {% endif %}
            </p>

            <div class="text-end mt-3">
                <a
                    class="btn btn-outline-light w-100 w-md-auto"
                    href="{{ url_for('flujo_export',
                                     date_from=date_from,
                                     date_to=date_to,
                                     category_filter=category_filter) }}"
                >
                    <i class="bi bi-file-earmark-excel me-1"></i> Exportar Excel
                </a>
            </div>
        </div>
    </div>
</div>

<!-- GRÁFICOS: UNO DEBAJO DEL OTRO -->
<div class="row">
    <div class="col-12">
        <div class="card p-4 mb-4">
            <h3 class="mb-3 text-accent">Vista general (barras)</h3>
            <p class="text-secondary-custom mb-3">
                Compara de manera directa tus <b>ingresos</b>, <b>ganancia</b>,
                <b>gastos</b>, <b>reinversión</b>, <b>egresos totales</b> y el
                <b>neto</b> en el periodo seleccionado.
            </p>
            <div class="chart-container" style="max-width: 420px; margin: 0 auto;">
                <canvas id="flujoBarChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card p-4">
            <h3 class="mb-3 text-accent">Distribución del flujo</h3>
            <p class="text-secondary-custom mb-3">
                La dona muestra cómo se reparte tu flujo entre <b>gastos</b>,
                <b>reinversión</b>, <b>ahorro objetivo</b> y <b>ahorro real estimado</b>.
            </p>
            <div class="chart-container" style="max-width: 420px; margin: 0 auto;">
                <canvas id="flujoPieChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- LISTADO DE MOVIMIENTOS -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card p-4">
            <h3 class="mb-3 text-accent">Movimientos registrados</h3>
            {% if expenses and expenses|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-dark table-striped table-sm align-middle">
                        <thead>
                            <tr class="text-center">
                                <th>Fecha</th>
                                <th>Descripción</th>
                                <th>Tipo</th>
                                <th>Monto (₡)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in expenses %}
                                <tr>
                                    <td class="text-center">{{ e.date }}</td>
                                    <td class="text-center">{{ e.description }}</td>
                                    <td class="text-center">{{ e.category }}</td>
                                    <td class="text-end text-accent">{{ "%.2f"|format(e.amount) }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-secondary-custom text-center mb-0">
                    No hay movimientos registrados en el rango seleccionado.
                </p>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const totalIngresos = {{ total_ingresos or 0 }};
    const totalGanancia = {{ total_ganancia or 0 }};
    const totalGastos = {{ total_gastos or 0 }};
    const totalReinv = {{ total_reinv or 0 }};
    const totalEgresos = {{ total_egresos or 0 }};
    const neto = {{ neto or 0 }};
    const ahorroObjetivo = {{ ahorro_objetivo or 0 }};
    const ahorroReal = {{ ahorro_real or 0 }};

    // Colores
    const barColors = [
        'rgba(0, 229, 229, 0.7)',  // Ingresos
        'rgba(0, 140, 255, 0.7)',  // Ganancia
        'rgba(255, 99, 132, 0.7)', // Gastos
        'rgba(255, 159, 64, 0.7)', // Reinv
        'rgba(153, 102, 255, 0.7)',// Egresos
        'rgba(75, 192, 192, 0.7)'  // Neto
    ];
    const barBorderColors = [
        '#00e5e5',
        '#008cff',
        '#ff6384',
        '#ff9f40',
        '#9966ff',
        '#4bc0c0'
    ];

    const pieColors = [
        'rgba(255, 99, 132, 0.7)', // Gastos
        'rgba(255, 159, 64, 0.7)', // Reinv
        'rgba(0, 229, 229, 0.7)',  // Ahorro objetivo
        'rgba(0, 140, 255, 0.7)'   // Ahorro real
    ];
    const pieBorderColors = [
        '#ff6384',
        '#ff9f40',
        '#00e5e5',
        '#008cff'
    ];

    // Gráfico de barras (uno)
    const ctxBar = document.getElementById('flujoBarChart');
    if (ctxBar) {
        new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: ['Ingresos', 'Ganancia', 'Gastos', 'Reinv.', 'Egresos', 'Neto'],
                datasets: [{
                    label: 'Monto (₡)',
                    data: [
                        totalIngresos,
                        totalGanancia,
                        totalGastos,
                        totalReinv,
                        totalEgresos,
                        neto
                    ],
                    backgroundColor: barColors,
                    borderColor: barBorderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { labels: { color: '#ffffff' } }
                },
                scales: {
                    x: {
                        ticks: { color: '#ffffff' },
                        grid: { color: '#333333' }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#ffffff' },
                        grid: { color: '#333333' }
                    }
                }
            }
        });
    }

    // Gráfico de dona (distribución)
    const ctxPie = document.getElementById('flujoPieChart');
    if (ctxPie) {
        new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: [
                    'Gastos',
                    'Reinversión',
                    'Ahorro objetivo',
                    'Ahorro real estimado'
                ],
                datasets: [{
                    data: [
                        totalGastos,
                        totalReinv,
                        ahorroObjetivo,
                        ahorroReal
                    ],
                    backgroundColor: pieColors,
                    borderColor: pieBorderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { labels: { color: '#ffffff' } }
                }
            }
        });
    }
});
</script>
{% endblock %}
