{% extends "base.html" %}
{% block title %}Ventas{% endblock %}

{% block content %}
<div class="card p-4 shadow-sm">
    <h3 class="text-center text-accent mb-3">Registrar Venta</h3>

    {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    {% if success %}
    <div class="alert alert-success">{{ success }}</div>
    {% endif %}

    <form method="post" id="ventaForm">
        <div class="row g-3">

            <!-- Fecha -->
            <div class="col-md-3">
                <label class="form-label">Fecha</label>
                <div class="input-group">
                    <span class="input-group-text date-icon">
                        <i class="bi bi-calendar3"></i>
                    </span>
                    <input type="date" name="date" class="form-control" required>
                </div>
            </div>

            <!-- Cliente -->
            <div class="col-md-3">
                <label class="form-label">Cliente</label>
                <select name="client_id" class="form-select">
                    <option value="">Escribir manual</option>
                    {% for c in clients %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Cliente manual -->
            <div class="col-md-3">
                <label class="form-label">Nombre Cliente (manual)</label>
                <input type="text" name="name" class="form-control">
            </div>

            <!-- Producto -->
            <div class="col-md-3">
                <label class="form-label">Producto</label>
                <select name="product_select" class="form-select">
                    <option value="">Escribir manual</option>
                    {% for p in products %}
                        <option value="{{ p.name }}">{{ p.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Producto manual -->
            <div class="col-md-3">
                <label class="form-label">Producto (manual)</label>
                <input type="text" name="product" class="form-control">
            </div>

            <!-- ESTADO -->
            <div class="col-md-3">
                <label class="form-label">Estado</label>
                <select name="status" id="statusSelect" class="form-select">
                    <option value="Pagado">Pagado</option>
                    <option value="Pendiente">Pendiente</option>
                </select>
            </div>

            <!-- TIPO DE PAGO -->
            <div class="col-md-3">
                <label class="form-label">Tipo de Pago</label>
                <select name="payment_type" class="form-select">
                    <option>Contado</option>
                    <option>Transferencia</option>
                    <option>Sinpe</option>
                    <option>Sinpe Móvil</option>
                </select>
            </div>

            <!-- COSTO / PRECIO / CANTIDAD -->
            <div class="col-md-12">
                <div class="row g-3 align-items-end">

                    <div class="col-md-4">
                        <label class="form-label">Costo por Unidad</label>
                        <input type="number" step="0.01" name="cost_per_unit" class="form-control" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Precio por Unidad</label>
                        <input type="number" step="0.01" name="price_per_unit" class="form-control" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Cantidad</label>
                        <input type="number" name="quantity" min="1" value="1" class="form-control" required>
                    </div>

                </div>
            </div>

            <!-- MONTO PAGADO -->
            <div class="col-md-4">
                <label class="form-label">Monto Pagado</label>
                <input type="number" step="0.01" name="amount_paid" id="amountPaid" class="form-control" disabled>
            </div>

            <!-- FECHA LIMITE -->
            <div class="col-md-4">
                <label class="form-label">Fecha Límite</label>
                <div class="input-group">
                    <span class="input-group-text date-icon">
                        <i class="bi bi-calendar3"></i>
                    </span>
                    <input type="date" name="due_date" id="dueDate" class="form-control" disabled>
                </div>
            </div>

            <!-- NOTAS -->
            <div class="col-md-12">
                <label class="form-label">Notas</label>
                <textarea name="notes" rows="2" class="form-control"></textarea>
            </div>

            <!-- BOTÓN -->
            <div class="col-md-12 text-center mt-3">
                <button class="btn btn-primary px-4">Guardar Venta</button>
            </div>

        </div>
    </form>
</div>

<br>

<!-- LISTADO DE VENTAS -->
<div class="card p-4 shadow-sm">
    <h3 class="text-center text-accent mb-3">Listado de Ventas</h3>

    <!-- Filtros -->
    <form class="row g-2 mb-3">
        <div class="col-md-3">
            <input type="text" name="filter_name" class="form-control" placeholder="Buscar cliente..." value="{{ filter_name }}">
        </div>

        <div class="col-md-3">
            <select name="filter_status" class="form-select">
                <option value="">Todos los estados</option>
                <option value="Pagado" {% if filter_status=='Pagado' %}selected{% endif %}>Pagado</option>
                <option value="Pendiente" {% if filter_status=='Pendiente' %}selected{% endif %}>Pendiente</option>
            </select>
        </div>

        <div class="col-md-2">
            <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
        </div>

        <div class="col-md-2">
            <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
        </div>

        <div class="col-md-2">
            <button class="btn btn-outline-light w-100">Filtrar</button>
        </div>
    </form>

    <div class="table-responsive">
        <table class="table table-dark table-striped text-center align-middle table-sm">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Producto</th>
                    <th>Total</th>
                    <th>Pagado</th>
                    <th>Pendiente</th>
                    <th>Estado</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                {% for s in sales %}
                <tr>
                    <td>{{ s.date }}</td>
                    <td>{{ s.name }}</td>
                    <td>{{ s.product }}</td>
                    <td>₡{{ s.total|format_num }}</td>
                    <td>₡{{ s.amount_paid|format_num }}</td>
                    <td>₡{{ s.pending_amount|format_num }}</td>
                    <td>{{ s.status }}</td>
                    <td>
                        <form method="post" action="{{ url_for('delete_sale', sale_id=s.id) }}" onsubmit="return confirm('¿Eliminar venta?')">
                            <button class="btn btn-sm btn-danger">
                                <i class="bi bi-trash3"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const statusSelect = document.getElementById("statusSelect");
    const amountPaid = document.getElementById("amountPaid");
    const dueDate = document.getElementById("dueDate");

    function togglePending() {
        const isPending = statusSelect.value === "Pendiente";
        amountPaid.disabled = !isPending;
        dueDate.disabled = !isPending;

        if (!isPending) {
            amountPaid.value = "";
            dueDate.value = "";
        }
    }

    statusSelect.addEventListener("change", togglePending);
    togglePending();
});
</script>

<style>
/* Date icon white and modern */
.date-icon {
    background: #333;
    color: #fff;
    border: 1px solid #444;
}

.date-icon i {
    font-size: 1.1rem;
}
</style>

{% endblock %}
