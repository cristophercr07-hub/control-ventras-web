@app.route("/ventas", methods=["GET", "POST"])
@login_required
def ventas():
    error = None
    success = None

    # --- alta de venta (POST) ---
    if request.method == "POST":
        try:
            date_str = request.form.get("date") or ""
            status = request.form.get("status") or "Pagado"
            name = request.form.get("name") or ""
            product_select = request.form.get("product_select") or ""
            product_text = request.form.get("product") or ""
            product_name = product_select or product_text

            cost_per_unit = float(request.form.get("cost_per_unit") or 0)
            price_per_unit = float(request.form.get("price_per_unit") or 0)
            quantity = int(request.form.get("quantity") or 1)

            pending_amount = float(request.form.get("pending_amount") or 0)
            due_date_str = request.form.get("due_date") or ""
            comment = request.form.get("comment") or ""

            date = datetime.date.fromisoformat(date_str) if date_str else datetime.date.today()
            due_date = datetime.date.fromisoformat(due_date_str) if due_date_str else None

            total = price_per_unit * quantity
            profit = (price_per_unit - cost_per_unit) * quantity

            sale = Sale(
                date=date,
                status=status,
                name=name,
                product=product_name,
                cost_per_unit=cost_per_unit,
                price_per_unit=price_per_unit,
                quantity=quantity,
                total=total,
                profit=profit,
                pending_amount=pending_amount if status == "Pendiente" else 0,
                due_date=due_date if status == "Pendiente" else None,
                user_id=session["user_id"],
                comment=comment,
            )
            db.session.add(sale)
            db.session.commit()
            success = "Venta registrada correctamente."
        except Exception as e:
            db.session.rollback()
            error = f"Error al registrar la venta: {e}"

    # --- filtros (GET) ---
    filter_name = request.args.get("filter_name", "").strip()
    filter_status = request.args.get("filter_status", "").strip()
    filter_user_id = request.args.get("filter_user_id", "").strip()
    date_from_str = request.args.get("date_from", "").strip()
    date_to_str = request.args.get("date_to", "").strip()

    query = Sale.query

    # Si quieres que cada usuario solo vea sus ventas, aplica filtro aquí:
    # query = query.filter(Sale.user_id == session["user_id"])

    if filter_name:
        query = query.filter(Sale.name.ilike(f"%{filter_name}%"))
    if filter_status:
        query = query.filter(Sale.status == filter_status)
    if filter_user_id:
        try:
            uid = int(filter_user_id)
            query = query.filter(Sale.user_id == uid)
        except ValueError:
            pass
    if date_from_str:
        try:
            df = datetime.date.fromisoformat(date_from_str)
            query = query.filter(Sale.date >= df)
        except ValueError:
            pass
    if date_to_str:
        try:
            dt = datetime.date.fromisoformat(date_to_str)
            query = query.filter(Sale.date <= dt)
        except ValueError:
            pass

    sales = query.order_by(Sale.date.desc(), Sale.id.desc()).all()

    total_ventas = len(sales)
    total_monto = sum(s.total or 0 for s in sales)
    total_ganancia = sum(s.profit or 0 for s in sales)
    total_pendiente = sum((s.pending_amount or 0) for s in sales if s.status == "Pendiente")
    total_pagado = total_monto - total_pendiente

    # Usuarios para el filtro
    users = User.query.order_by(User.username).all()

    # Productos del catálogo del usuario
    products = Product.query.filter_by(user_id=session["user_id"]).order_by(Product.name).all()

    # Mapeo robusto para JS
    product_mapping = {
        p.name: {
            "cost": float(p.cost or 0),
            "price": float(p.price or 0),
        }
        for p in products
    }

    return render_template(
        "ventas.html",
        error=error,
        success=success,
        sales=sales,
        total_ventas=total_ventas,
        total_monto=total_monto,
        total_ganancia=total_ganancia,
        total_pendiente=total_pendiente,
        total_pagado=total_pagado,
        filter_name=filter_name,
        filter_status=filter_status,
        filter_user_id=filter_user_id,
        date_from=date_from_str,
        date_to=date_to_str,
        users=users,
        products=products,
        product_mapping=product_mapping,
    )
